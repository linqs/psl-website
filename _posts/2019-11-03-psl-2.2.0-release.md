---
layout: post
title: PSL 2.2.0 Release
author: Eriq Augustine & Vihang Godbole
date: 2019-11-03 10:00:00 -0700
tags: [release, v2.2.0]
---

We are happy to announce the release of PSL version `2.2.0`!
We have made great improvements to PSL in the areas of usability and performance.

Here you will find a list of the major changes in `2.2.0` as well as information on migrating from `2.1.0`.

For those of you that learn better by example, check out the [PSL examples repository](https://github.com/linqs/psl-examples).
The `master` branch is always compatible with the most resent stable release,
while the `develop` branch stays up-to-date with our development work.

 - [Infrastructure](#infrastructure)
   - [Artifacts Moved to Maven Central](#artifacts-moved-to-maven-central)
   - [Wiki Hosted on psl.linqs.org](#wiki-hosted-on-psl.linqs.org)
   - [Development Repo Now linqs/psl](#development-repo-now-linqs/psl)
   - [Issues Moved to linqs/psl](#issues-moved-to-linqs/psl)

 - [PSL Interfaces](#psl-interfaces)
   - [New Python Interface](#new-python-interface)
   - [New Java Interface](#new-java-interface)
   - [Groovy Interface Deprecated](#groovy-interface-deprecated)

 - [CLI Improvements](#cli-improvements)
   - [Functional Predicates](#functional-predicates)
   - [Multiple Evaluators](#multiple-evaluators)
   - [Output Ground Rules](#output-ground-rules)
   - [Skip Database Commit](#skip-database-update)
   - [Simple Class Names](#simple-class-names)
   - [Remove Extra Quoting](#removed-extra-quoting)
   - [run.sh Takes Arguments](#run.sh-takes-arguments)

 - [Performance](#performance)
   - [Reduced Memory Allocations](#reduced-memory-allocations)
   - [Smaller Types](#smaller-types)
   - [Matrix Operations](#matrix-operations)
   - [Streaming Grounding Results](#streaming-grounding-results)
   - [Runtime Statistics](#runtime-statistics)

 - [Miscellanea](#miscellanea)
   - [New Weight Learning Method: GPP](#new-weight-learning-method-gpp)
   - [Made Data Loading Errors More Clear](#made-data-loading-errors-more-clear)
   - [Removed Date ConstantType](#removed-date-constanttype)

---

## Infrastructure
The 2.2.0 release comes with a few changes to the PSL development cycle and artifact deployment.

### Artifacts Moved to Maven Central
Starting with this release, PSL releases and artifacts will now be hosted through [Maven Central](https://mvnrepository.com/repos/central).
Maven Central is the default remote repository for Maven.
With PSL deployed there, there is no longer a need to use the old Maven repository at:
`http://maven.linqs.org/maven/repositories/psl-releases/`.
Old builds will continue to be hosted at the old repository for the foreseeable future.
To find the new builds you can either search directly for `PSL` or for the group ID - `org.linqs` on Maven Central. The latest development versions are labeled as `CANARY` releases.

### Wiki Hosted on psl.linqs.org
The PSL Wiki (https://github.com/linqs/psl/wiki)
and PSL Development Wiki (https://github.com/eriq-augustine/psl/wiki)
have been moved to this site at [psl.linqs.org/wiki](https://psl.linqs.org/wiki/).
All stable and development releases going forward will have a version of the wiki available as either
live webpages (for newer releases) or downloadable archives (for older releases). NOTE: Internal LINQS members can edit the Wiki pages by clicking the `Edit this Page` button at the bottom.


### API Reference Hosted on psl.linqs.org
Along with the Wiki, the API reference will now also be hosted on this site at [psl.linqs.org/api](https://psl.linqs.org/api/).
All stable and development releases going forward will have a version of the API reference available as either
live webpages (for newer releases) or downloadable archives (for older releases).

### Development Repo Now linqs/psl
PSL development has been moved from [eriq-augustine/psl](https://github.com/eriq-augustine/psl)
to the canonical PSL repository: [linqs/psl](https://github.com/linqs/psl).
Any new pull requests should be submitted there.

### Issues Moved to linqs/psl
Along with pull requests, issues have been moved to the canonical PSL repository: [linqs/psl/issues](https://github.com/linqs/psl/issues).
All old issues (along the with their comments and labels) have been migrated to this repository and any new issues should be submitted there.

## PSL Interfaces
The PSL 2.2.0 release comes with two new interfaces, and deprecates one.

### New Python Interface
[*a38cffe5*](https://github.com/linqs/psl/commit/a38cffe5866f070f7db9665b5fa94f4f9d957a44)

PSL 2.2.0 comes with the first official release of the PSL Python interface.
This package is called `pslpython` and is [available on PyPi](https://pypi.org/project/pslpython).
Therefore is can be installed via pip:
```
pip install pslpython
```
The source of the interface is available in the [main PSL repository](https://github.com/linqs/psl/tree/master/psl-python).

Fully implemented examples can be found in the [psl-examples repository](https://github.com/linqs/psl-examples).
Below is a simplified example of the Python interface:
```python
    import os

    from pslpython.model import Model
    from pslpython.partition import Partition
    from pslpython.predicate import Predicate
    from pslpython.rule import Rule

    model = Model('sample-model')

    # Add Predicates
    predicate = Predicate('Foo', closed = True, size = 2)
    model.add_predicate(predicate)

    predicate = Predicate('Bar', closed = False, size = 2)
    model.add_predicate(predicate)

    # Add Rules
    model.add_rule(Rule('0.20: Foo(A, B) -> Bar(A, B) ^2'))
    model.add_rule(Rule('0.01: !Bar(A, B) ^2'))

    # Load data.
    path = os.path.join('data', 'foo_obs.txt')
    model.get_predicate('Foo').add_data_file(Partition.OBSERVATIONS, path)

    path = os.path.join('data', 'bar_targets.txt')
    model.get_predicate('Bar').add_data_file(Partition.TARGETS, path)

    # Inference
    results = model.infer()

    # Write out results.
    out_dir = 'inferred-predicates'
    os.makedirs(out_dir, exist_ok = True)

    out_path = os.path.join(out_dir, "bar.txt")
    results[model.get_predicate('Bar')].to_csv(out_path, sep = "\t", header = False, index = False)
```

In addition to creating models in Python, you can use the PSL python package to invoke the PSL CLI interface directory.
Instead of invoking the PSL jar:
```sh
java -jar psl.jar --model test.psl --data test.data
```
You can use the `pslpython` package already installed via pip:
```sh
python -m pslpython.cli --model test.psl --data test.data
```

Additionally, any arguments supported by the CLI interface can be passed to `pslpython.cli` as well:
```sh
python -m pslpython.cli --model test.psl --data test.data --eval DiscreteEvaluator -D log4j.threshold=DEBUG
```

### New Java Interface
[*7e305dfe*](https://github.com/linqs/psl/commit/7e305dfea1a0e092b43ece80f4e44f71777ee330)

PSL 2.2.0 comes with a new Java interface.
This interface works much like the Groovy interface with some slight differences.
Fully implemented examples of the Java interface can be found in the [psl-examples repository](https://github.com/linqs/psl-examples).

Instead of using `org.linqs.psl.groovy.PSLModel`, `org.linqs.psl.java.PSLModel` is used.
The methods for the `PSL` model class are now explicitly named, instead of all called `add`.
For example, instead of `model.add predicate: "Foo", ...`, you will use `model.addPredicate("Foo", ...)`.
The full API for the PSLModel class can be found [here](https://psl.linqs.org/api/2.2.0/org/linqs/psl/java/PSLModel.html).

The Groovy interface allows rules to be specified as part of the Groovy syntax.
However, rules in the Java interface must be specified as a String.

To access predicates in the Java interface, you can no longer just reference them by name with no context.
Now, you can ask the model for a predicate by name.
In Groovy:
```
Inserter inserter = dataStore.getInserter(Foo, obsPartition);
```
In Java:
```
Inserter inserter = dataStore.getInserter(model.getStandardPredicate("Foo"), obsPartition);
```

### Groovy Interface Deprecated
[*476dfd1e*](https://github.com/linqs/psl/commit/476dfd1e745919dc5a2cef4ac521806eb252cac1)

With the addition of the [new Java interface](#new-java-interface), the Groovy interface has officially been deprecated.
It will be removed from the next release of PSL.
Dropping support for Groovy will allow us to support a wider range of Java versions (instead of just 7 and 8).

## CLI Improvements

### Functional Predicates
[*ac2f9a30*](https://github.com/linqs/psl/commit/ac2f9a30d42951a4c0c9a90ade1edfdce0e2fe5d)
[Functional predicates](https://psl.linqs.org/wiki/master/External-Functions.html) are now supported in the CLI.
To use these, a function key needs to be specified in the predicate definition, e.g:
```yaml:
  Knows/2: open
  Likes/2: closed
  Lived/2: closed
  SimName:
    - function: org.foo.bar.SimNameExternalFunction
```

In this case, the functional predicate is `SimName` and it is implemented by the `SimNameExternalFunction` class.
This can then be used in a rule like:
```
1: SimName(P1, P2) & Lived(P1, L) & Lived(P2, L) & (P1 != P2) -> Knows(P1, P2) ^2
```

### Multiple Evaluators
[*d63a8f7e*](https://github.com/linqs/psl/commit/d63a8f7ee1c9bfb881bb53770e3e84db34c2668b)

The CLI can now use multiple evaluators in one run.
This can be done by passing by multiple evaluators to the `--eval` argument:
```
java -jar psl.jar --model test.psl --data test.data --eval DiscreteEvaluator ContinuousEvaluator
```

### Output Ground Rules
[*62fbd2cc*](https://github.com/linqs/psl/commit/62fbd2cc20c8360c365a02be2cdc4f871a4f5798)
[*b901e937*](https://github.com/linqs/psl/commit/b901e937ed2869b5dcc184585ea29c5fa77b1170)

The CLI accepts two new arguments that can be used to see the ground rules being processed.
`-gr`/`--groundrules` can be used to output the ground rules **before** inference is run.
This will show the ground rules as early as possible.
While `--satisfaction` will output ground rules along with their satisfaction value **after** inference is run.

If you are concerned about an issue with your rules/data and want to see the ground rules created,
then `--groundrules` is the option you should use.
If you are curious about the value that different rules are taking,
then `--satisfaction` is the option you should use.

Either option can be specified without arguments, and the results will be output to stdout.
You can also specify an optional path with either argument and the results will be output there.

### Skip Database Commit
[*3ced4b20*](https://github.com/linqs/psl/commit/3ced4b20be80fc17403663fe16e194bcfcaf6a3a)

If you do not need the results of inference saved into the database,
then you can save time by skipping the writing of results to the database using the `--skipCommitAtoms` argument.

### Remove Extra Quoting
[*cbe7fd8a*](https://github.com/linqs/psl/commit/cbe7fd8a3c8e5dc9a296836f5574e98353328323)

Constants are no longer quoted in inferred predicate output produced by the CLI.
This may break existing scripts that parse this output,
but now files output by the CLI will match the format consumed by the CLI (by default).

### run.sh Takes Arguments

The `run.sh` scripts in CLI implementations for `psl-examples` now takes arguments that are passed directly to the CLI.
Specifying these arguments is equivalent to adding these arguments to the `ADDITIONAL_PSL_OPTIONS` constant.
For example:
```
./run.sh -D log4j.threshold=DEBUG --postgres psl
```

For a list of supported arguments you can use `--help`. Additionally, for a list of supported configuration options you can refer to the page titled `Configuration Options` in the wiki. 

## Performance

### Reduced Memory Allocations

A lot of effort was put into reducing the memory burden of PSL for the 2.2.0 release.
Both in terms of allocations and total persisted memory.

TODO(eriq): Get some stats

### Smaller Types
[*9a34ce23*](https://github.com/linqs/psl/commit/9a34ce235b65cd549c28b9b64cbc94a496d1350c)

Where possible, standard types have been replaced by their shorter sibling
(`int` replaced with `short`, `double` replaced with `float`, etc).
This allows us to trade unused precision for memory and speed (depending on the system architecture).

### Matrix Operations
[*8f034fa8*](https://github.com/linqs/psl/commit/8f034fa8315d3f6461cd38435612d889c745f4a2)

Added a class [`FloatMatrix`](https://psl.linqs.org/api/2.2.0/org/linqs/psl/util/FloatMatrix.html)
to handle low-level matrix operations.
This classes uses the [Netlib library](https://www.netlib.org/) to call into the low-level BLAS and LAPACK libraries.
This allows us to easily perform efficient matrix operations.

### Streaming Grounding Results
[*8f4de846*](https://github.com/linqs/psl/commit/8f4de8464b79ace097ad577dff0bcbfa63369b3e)

Grounding results can now be streamed from the database using the [`QueryResultIterable`](https://psl.linqs.org/api/develop/org/linqs/psl/database/QueryResultIterable.html) class.
This allows the user to iterate through the grounding results without needing to keep them all in memory at the same time.

### Runtime Statistics
[*df58a390*](https://github.com/linqs/psl/commit/df58a390181a1f32ef536674e56e92d20d2257e0)

A new class [RuntimeStats](https://psl.linqs.org/api/develop/org/linqs/psl/util/RuntimeStats.html)
has been introduced to keep track of JVM statistics throughout the lifetime of a PSL program.
Setting the configuration option `runtimestats.collect` to `true` will enable the statistics collection.
These collected stats are currently output to the `INFO` log level when the JVM terminates.

Currently, memory information is automatically collected.
In addition, the user can call the static `logDiskRead` and `logDiskWrite` methods to keep track of I/O operations.

Using the statistics looks like:
```
eriq@MrMime:~/code/psl-examples/simple-acquaintances/cli$ ./run.sh -D runtimestats.collect=true
Running PSL Inference
0    [main] INFO  org.linqs.psl.cli.Launcher  - Running PSL CLI Version 2.2.0-SNAPSHOT-9335e9a
... < Omitted in the changelog for brevity > ...
3372 [main] INFO  org.linqs.psl.cli.Launcher  - Inference Complete
3384 [main] INFO  org.linqs.psl.cli.Launcher  - Starting evaluation with class: org.linqs.psl.evaluation.statistics.DiscreteEvaluator.
3423 [main] INFO  org.linqs.psl.cli.Launcher  - Evaluation results for KNOWS -- Accuracy: 0.915254, F1: 0.933333, Positive Class Precision: 0.945946, Positive Class Recall: 0.921053, Negative Class Precision: 0.863636, Negative Class Recall: 0.904762
3423 [main] INFO  org.linqs.psl.cli.Launcher  - Evaluation complete.
3435 [Thread-1] INFO  org.linqs.psl.util.RuntimeStats  - Total Memory (bytes) -- Min:    123207680, Max:    123207680, Mean:    123207680, Count:           14
3436 [Thread-1] INFO  org.linqs.psl.util.RuntimeStats  - Free Memory (bytes)  -- Min:     88010064, Max:    116031808, Mean:    101241578, Count:           14
3436 [Thread-1] INFO  org.linqs.psl.util.RuntimeStats  - Used Memory (bytes)  -- Min:      7175872, Max:     35197616, Mean:     21966095, Count:           14
3437 [Thread-1] INFO  org.linqs.psl.util.RuntimeStats  - Max Memory (bytes)   -- Min:   1832386560, Max:   1832386560, Mean:   1832386560, Count:           14
3437 [Thread-1] INFO  org.linqs.psl.util.RuntimeStats  - IO Reads (bytes)     -- Min:            0, Max:            0, Mean:            0, Count:            0, Total:            0
3437 [Thread-1] INFO  org.linqs.psl.util.RuntimeStats  - IO Writes (bytes)    -- Min:            0, Max:            0, Mean:            0, Count:            0, Total:            0
eriq@MrMime:~/code/psl-examples/simple-acquaintances/cli$
```

## Miscellanea


### Simple Class Names
[*00b60321*](https://github.com/linqs/psl/commit/00b603211d070729bc486c558846c3cfebcc4bb7)

In any case where a classname is used as a configuration option or argument,
you can now specify the classes shortname instead of its fully-qualified name.
For example, instead of:
```
java -jar psl.jar --model test.psl --data test.data --eval org.linqs.psl.evaluation.statistics.DiscreteEvaluator
```
You can do:
```
java -jar psl.jar --model test.psl --data test.data --eval DiscreteEvaluator
```

### New Weight Learning Method: GPP

PSL makes use of rules to model the underlying Hinge Loss Markov Random Fields (HL-MRFs). These rules usually take form of -
 ```
 10.0: Friends(A, B) -> Trusts(A, B) ^2
 5.0: Friends(A, B) & Friends(B, C) -> Trusts(A, C) ^2
 ```
Each rule has with a weight associated with it and this weight represents how important the rule is relative to other rules. PSL supports a number of algorithms to learn these weights. With the release of PSL 2.2.0, we are now adding support for a new weight learning algorithm called Gaussian Process Prior(GPP) which is based on bayesion optimization.
Gausian process prior searches for the best set of weights for rules in a bayesian optimization setting. GPP works by approximating a user defined metric function and evaluating the PSL model on N strategically chosen weights. It returns the set of weights that maximize this approximation. For further details about GPP please see: https://linqs.soe.ucsc.edu/node/355

To make use of this approach in the PSL CLI, the class name `org.linqs.psl.application.learning.weight.bayesian.GaussianProcessPrior` should be passed to the `--learn` argument and a metric functino to optmize should be passed to the `--eval` parameter.

E.g.:
```
java -jar psl.jar --model test.psl --data test_learn.data --learn GaussianProcessPrior --eval ContinuousEvaluator
```

GPP has three main hyperparameters that can be tuned for better results:
1. `-D gpp.maxiterations=25`
This sets the maximum number of times that BOWL will conduct evaluations before choosing the best set of weights. 
NOTE: A number of 100 should be reasonable. Keep in mind that the time taken to perform full learning in BOWL grows quadratically with the number of iterations. Therefore, if you choose a large number (such as 500), learning might take days to finish.

2. `-D gppker.reldep=1.0`
This is the relative dependence value given in GPP. 
The exploration space increases as the number of rules in the model increase.
A smaller value would imply that weights are very distinct and related, hence requiring lesser number of iterations. 
The value should be a positive floating point number.

3. `-D gpp.explore=2.0`
This parameter determines how the weights will be chosen for evaluation.
A lower value implies that the weights chosen for evaluation will be clustered around one region whereas a higher value will lead to exploration of weights that are as distinct as possible.

### Made Data Loading Errors More Clear
[*1e889f49*](https://github.com/linqs/psl/commit/1e889f49d23ebc438e581fec8a092e50526d9550)

File paths were added to several data loading errors in hopes of making them more clear.

### Removed Date ConstantType
[*df5e1b64*](https://github.com/linqs/psl/commit/df5e1b641d5274dd590bc2a917259a9e38bed464)

The `ConstantType.Date` type have been removed as predicate argument type.
Instead, users should use `ConstantType.String` with the date represented as a string (we suggest [ISO 8601](https://en.wikipedia.org/wiki/ISO_8601)),
or users should use `ConstantType.Integer` and represent the date as an [Unix/Epoch time](https://en.wikipedia.org/wiki/Unix_time).
